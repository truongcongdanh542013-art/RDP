name: ğŸš€ LongVPS

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Thá»i gian sá»­ dá»¥ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h'
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340

    steps:
      # BANNER CHÃ€O Má»ªNG
      - name: ğŸ¯ KHá»I Äá»˜NG Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host ""
          Write-Host "ğŸ¤– Longday SERVER" -ForegroundColor Yellow
          Write-Host "âš¡ Powered by AIL" -ForegroundColor Green
          Write-Host "ğŸ•’ Thá»i gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          $frames = @('â£¾','â£½','â£»','â¢¿','â¡¿','â£Ÿ','â£¯','â£·')
          for($i=0;$i -lt 10;$i++){Write-Host "`rğŸš€ Äang khá»Ÿi táº¡o há»‡ thá»‘ng... $($frames[$i%8])" -NoNewline -ForegroundColor Blue; Start-Sleep -Milliseconds 100}
          Write-Host "`râœ… Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng!                    " -ForegroundColor Green

      # Cáº¤U HÃŒNH Há»† THá»NG
      - name: ğŸ”§ Cáº¤U HÃŒNH Há»† THá»NG
        run: |
          Write-Host ""
          Write-Host "ğŸ› ï¸  ÄANG Cáº¤U HÃŒNH Há»† THá»NG" -ForegroundColor Yellow
          $steps=@(
            @{Name="Báº­t Remote Desktop"; Script={Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force}},
            @{Name="Táº¯t xÃ¡c thá»±c máº¡ng"; Script={Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force}},
            @{Name="Cáº¥u hÃ¬nh báº£o máº­t RDP"; Script={Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force;Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force}},
            @{Name="Má»Ÿ port 3389 firewall"; Script={netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any; netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any}},
            @{Name="Khá»Ÿi Ä‘á»™ng dá»‹ch vá»¥"; Script={Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue; Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue; Start-Service -Name TermService -ErrorAction SilentlyContinue; Start-Service -Name UmRdpService -ErrorAction SilentlyContinue}}
          )
          foreach($step in $steps){Write-Host "â”‚ ğŸ“‹ $($step.Name)..." -NoNewline -ForegroundColor White; try{& $step.Script; Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green} catch {Write-Host "`râ”‚ âš ï¸  $($step.Name) - Bá» qua lá»—i nhá»" -ForegroundColor Yellow}; Start-Sleep -Milliseconds 500}
          Write-Host "ğŸ¯ Cáº¥u hÃ¬nh hoÃ n táº¥t!" -ForegroundColor Green

      # ğŸ–¼ï¸ SET RDP WALLPAPER
      - name: ğŸ–¼ï¸ Set RDP Wallpaper
        shell: powershell
        run: |
          Write-Host "ğŸ”„ Äang táº£i vÃ  Ä‘á»•i hÃ¬nh ná»n RDP..." -ForegroundColor Cyan
          $url="https://raw.githubusercontent.com/truongcongdanh542013-art/-i/232a55d5596db3f6f78d22423e2e7353e13dca2c/DF651AEC-04F3-401D-899D-E1D540A1B488.jpeg"
          $path="C:\Users\Public\wallpaper.jpg"
          [Net.ServicePointManager]::SecurityProtocol=[Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest -Uri $url -OutFile $path -UseBasicParsing -ErrorAction Stop
          $defaultReg="HKU\.DEFAULT\Control Panel\Desktop"
          if(-not (Test-Path $defaultReg)){New-Item -Path $defaultReg -Force}
          Set-ItemProperty -Path $defaultReg -Name Wallpaper -Value $path
          RUNDLL32.EXE USER32.DLL,UpdatePerUserSystemParameters
          Write-Host "ğŸ‰ HÃ¬nh ná»n RDP Ä‘Ã£ cáº­p nháº­t thÃ nh cÃ´ng!" -ForegroundColor Green

      # ğŸš€ BOOST Máº NG
      - name: ğŸš€ BOOST Máº NG â€“ Unlock Bandwidth
        run: |
          Write-Host "ğŸ”§ Unlock 100% bandwidth (NonBestEffortLimit -> 0)" -ForegroundColor Yellow
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\Psched" /v "NonBestEffortLimit" /t REG_DWORD /d 0 /f
          Write-Host "âœ… ÄÃ£ unlock bandwidth" -ForegroundColor Green

      # ğŸ‘¤ Táº O USER PREMIUM
      - name: ğŸ‘¤ Táº O TÃ€I KHOáº¢N PREMIUM
        run: |
          Write-Host "ğŸ‘¤ ÄANG Táº O TÃ€I KHOáº¢N PREMIUM" -ForegroundColor Yellow
          function New-PremiumPassword{param();$upper='ABCDEFGHJKLMNPQRSTUVWXYZ';$lower='abcdefghijkmnpqrstuvwxyz';$numbers='23456789';$all=$upper+$lower+$numbers;$pw='';$pw+=$upper[(Get-Random -Minimum 0 -Maximum $upper.Length)];$pw+=$lower[(Get-Random -Minimum 0 -Maximum $lower.Length)];$pw+=$numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)];for($i=1;$i -le 5;$i++){$pw+=$all[(Get-Random -Minimum 0 -Maximum $all.Length)]};return -join ($pw.ToCharArray()|Sort-Object{Get-Random})}
          if($env:CUSTOM_RDP_PASS){$matKhau=$env:CUSTOM_RDP_PASS;Write-Host "â”‚ â„¹ï¸  DÃ¹ng máº­t kháº©u tÃ¹y chá»‰nh tá»« env" -ForegroundColor Blue}else{$matKhau=New-PremiumPassword}
          $securePass=ConvertTo-SecureString $matKhau -AsPlainText -Force
          try{Remove-LocalUser -Name "LongDay2203" -ErrorAction SilentlyContinue}catch{}
          try{New-LocalUser -Name "LongDay2203" -Password $securePass -AccountNeverExpires -Description "LongDay Premium User";Enable-LocalUser -Name "LongDay2203";Add-LocalGroupMember -Group "Administrators" -Member "LongDay2203";Add-LocalGroupMember -Group "Remote Desktop Users" -Member "LongDay2203"}catch{Write-Host "â”‚ âŒ Lá»—i táº¡o user: $($_.Exception.Message)" -ForegroundColor Red; exit 1}
          echo "RDP_USER=LongDay2203" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          Write-Host "âœ… TÃ i khoáº£n LongDay2203 Ä‘Ã£ sáºµn sÃ ng" -ForegroundColor Green

      # ğŸ” KIá»‚M TRA QUYá»€N Há»† THá»NG
      - name: ğŸ” KIá»‚M TRA QUYá»€N Há»† THá»NG
        run: |
          $user=Get-LocalUser -Name "LongDay2203" -ErrorAction SilentlyContinue
          if($user){Write-Host "â”‚ âœ… User LongDay2203 tá»“n táº¡i" -ForegroundColor Green}else{exit 1}
          $isAdmin=(Get-LocalGroupMember -Group "Administrators"|Where-Object{$_.Name -like "*LongDay2203"}).Count -gt 0
          if($isAdmin){Write-Host "â”‚ âœ… CÃ³ quyá»n Administrator" -ForegroundColor Green}
          $isRDPUser=(Get-LocalGroupMember -Group "Remote Desktop Users"|Where-Object{$_.Name -like "*LongDay2203"}).Count -gt 0
          if($isRDPUser){Write-Host "â”‚ âœ… CÃ³ quyá»n Remote Desktop" -ForegroundColor Green}
          $termService=Get-Service -Name TermService
          if($termService.Status -eq 'Running'){Write-Host "â”‚ âœ… Dá»‹ch vá»¥ TermService Ä‘ang cháº¡y" -ForegroundColor Green}
          Write-Host "ğŸ¯ Kiá»ƒm tra hoÃ n táº¥t!" -ForegroundColor Green

      # ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
      - name: ğŸŒ THIáº¾T Láº¬P Máº NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "ğŸŒ ÄANG THIáº¾T Láº¬P Káº¾T Ná»I Máº NG" -ForegroundColor Yellow
          $msiPath="$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i","`"$msiPath`"","/quiet","/norestart" -Wait
          Remove-Item $msiPath -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=LongDay-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          $ip=$null
          for($i=0;$i -lt 20;$i++){try{$ip=& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4;if($ip -match '^\d+\.\d+\.\d+\.\d+$'){echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV; break}}catch{}; Start-Sleep -Seconds 3}
          if(-not $ip){echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV; Write-Host "âš ï¸ KhÃ´ng thá»ƒ láº¥y IP Tailscale" -ForegroundColor Yellow}

      # ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
      - name: ğŸ‰ THÃ”NG TIN Káº¾T Ná»I
        run: |
          $matKhau=Get-Content $env:TEMP\rdp_password.txt
          $durationInput="${{ github.event.inputs.duration }}"
          switch($durationInput){ "1h"{$totalMinutes=60;$displayTime="1 giá»"} "3h"{$totalMinutes=180;$displayTime="3 giá»"} "5h40m"{$totalMinutes=340;$displayTime="5 giá» 40 phÃºt"} default{$totalMinutes=340;$displayTime="5 giá» 40 phÃºt"} }
          $timeZone=[System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $start=[System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(),$timeZone)
          $end=$start.AddMinutes($totalMinutes)
          Write-Host "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”" -ForegroundColor Cyan
          Write-Host "â”‚              ğŸ‰ Káº¾T Ná»I THÃ€NH CÃ”NG!              â”‚" -ForegroundColor Cyan
          Write-Host "â”‚ ğŸŒ  Äá»‹a chá»‰: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "â”‚ ğŸ‘¤  TÃ i khoáº£n: LongDay2203" -ForegroundColor White
          Write-Host "â”‚ ğŸ”  Máº­t kháº©u: $matKhau" -ForegroundColor White
          Write-Host "â”‚ â°  Thá»i lÆ°á»£ng: $displayTime" -ForegroundColor White
          Write-Host "â”‚ ğŸ•  Báº¯t Ä‘áº§u: $($start.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ•  Káº¿t thÃºc: $($end.ToString('HH:mm:ss'))" -ForegroundColor White
          Write-Host "â”‚ ğŸ“  Port: 3389" -ForegroundColor White
          Write-Host "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜" -ForegroundColor Cyan
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      # â³ DUY TRÃŒ PHIÃŠN
      - name: â³ DUY TRÃŒ PHIÃŠN LÃ€M VIá»†C
        run: |
          $totalMinutes=[int]$env:TOTAL_MINUTES
          $timeZone=[System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $start=[System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(),$timeZone)
          $end=$start.AddMinutes($totalMinutes)
          Write-Host "ğŸ”„ Báº®T Äáº¦U DUY TRÃŒ PHIÃŠN..." -ForegroundColor Yellow
          do{$now=[System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(),$timeZone);$remain=$end-$now;$h=[math]::Max(0,[math]::Floor($remain.TotalHours));$m=[math]::Max(0,[math]::Floor($remain.TotalMinutes%60));$s=[math]::Max(0,[math]::Floor($remain.TotalSeconds%60));Write-Host "`râ³ Thá»i gian cÃ²n láº¡i: $h giá» $m phÃºt $s giÃ¢y" -NoNewline -ForegroundColor Cyan;Start-Sleep -Seconds 5} while($remain.TotalSeconds -gt 0)
          Write-Host "ğŸ¯ Háº¾T THá»œI GIAN â€” Tá»° Äá»˜NG Dá»ªNG!" -ForegroundColor Red

      # ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
      - name: ğŸ§¹ Dá»ŒN Dáº¸P Há»† THá»NG
        if: always()
        run: |
          Write-Host "ğŸ§¹ ÄANG Dá»ŒN Dáº¸P Há»† THá»NG..." -ForegroundColor Yellow
          $steps=@(
            @{Name="XÃ³a file password"; Script={Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue}},
            @{Name="VÃ´ hiá»‡u hÃ³a user"; Script={Disable-LocalUser -Name "LongDay2203" -ErrorAction SilentlyContinue}},
            @{Name="ÄÃ³ng káº¿t ná»‘i Tailscale"; Script={& "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue}},
            @{Name="XÃ³a rule firewall"; Script={netsh advfirewall firewall delete rule name="RDP-Premium" -ErrorAction SilentlyContinue; netsh advfirewall firewall delete rule name="RDP-Premium-Out" -ErrorAction SilentlyContinue}},
            @{Name="KhÃ´i phá»¥c RDP"; Script={Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue; Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue}}
          )
          foreach($step in $steps){Write-Host "â”‚ ğŸ—‘ï¸  $($step.Name)..." -NoNewline -ForegroundColor Gray; try{& $step.Script; Write-Host "`râ”‚ âœ… $($step.Name)" -ForegroundColor Green} catch {Write-Host "`râ”‚ âš ï¸  $($step.Name) - ÄÃ£ xá»­ lÃ½ an toÃ n" -ForegroundColor Yellow}; Start-Sleep -Milliseconds 300}
          Write-Host "ğŸ‰ Dá»ŒN Dáº¸P HOÃ€N Táº¤T! Háº¸N Gáº¶P Láº I ğŸ‘‹" -ForegroundColor Green
