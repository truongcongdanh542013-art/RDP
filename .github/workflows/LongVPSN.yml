name: üöÄ LongVPS 

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '5h40m'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '5h40m'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 340
    
    steps:
      # BANNER CH√ÄO M·ª™NG
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host "ü§ñ Longday SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AIL" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host ""
          $frames = @('‚£æ','‚£Ω','‚£ª','‚¢ø','‚°ø','‚£ü','‚£Ø','‚£∑')
          for($i=0; $i -lt 10; $i++) {
            Write-Host "`rüöÄ ƒêang kh·ªüi t·∫°o h·ªá th·ªëng... $($frames[$i % 8])" -NoNewline -ForegroundColor Blue
            Start-Sleep -Milliseconds 100
          }
          Write-Host "`r‚úÖ H·ªá th·ªëng ƒë√£ s·∫µn s√†ng!                    " -ForegroundColor Green

      # C·∫§U H√åNH H·ªÜ TH·ªêNG
      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG
        run: |
          Write-Host ""
          Write-Host "üõ†Ô∏è  ƒêANG C·∫§U H√åNH H·ªÜ TH·ªêNG" -ForegroundColor Yellow
          $steps = @(
              @{Name="B·∫≠t Remote Desktop"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force }},
              @{Name="T·∫Øt x√°c th·ª±c m·∫°ng"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force }},
              @{Name="C·∫•u h√¨nh b·∫£o m·∫≠t RDP"; Script={ Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force; Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force }},
              @{Name="M·ªü port 3389 firewall"; Script={ netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any; netsh advfirewall firewall add rule name="RDP-Premium-Out" dir=out action=allow protocol=TCP localport=3389 profile=any }},
              @{Name="Kh·ªüi ƒë·ªông d·ªãch v·ª•"; Script={ Set-Service -Name TermService -StartupType Automatic -ErrorAction SilentlyContinue; Set-Service -Name UmRdpService -StartupType Automatic -ErrorAction SilentlyContinue; Start-Service -Name TermService -ErrorAction SilentlyContinue; Start-Service -Name UmRdpService -ErrorAction SilentlyContinue }}
          )
          foreach($step in $steps) {
              Write-Host "‚îÇ üìã $($step.Name)..." -NoNewline -ForegroundColor White
              try { & $step.Script; Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green } 
              catch { Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - ƒê√£ b·ªè qua l·ªói nh·ªè" -ForegroundColor Yellow }
              Start-Sleep -Milliseconds 500
          }
          Write-Host "üéØ C·∫•u h√¨nh ho√†n t·∫•t!" -ForegroundColor Green

      # BOOST M·∫†NG
      - name: üöÄ BOOST M·∫†NG ‚Äì Unlock Bandwidth
        run: |
          Write-Host "üîß Unlock 100% bandwidth (NonBestEffortLimit -> 0)" -ForegroundColor Yellow
          reg add "HKLM\SOFTWARE\Policies\Microsoft\Windows\Psched" /v "NonBestEffortLimit" /t REG_DWORD /d 0 /f
          Write-Host "‚úÖ ƒê√£ unlock bandwidth" -ForegroundColor Green

      # T·∫†O USER PREMIUM
      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          Write-Host "üë§ ƒêANG T·∫†O T√ÄI KHO·∫¢N PREMIUM" -ForegroundColor Yellow
          function New-PremiumPassword {
              $upper='ABCDEFGHJKLMNPQRSTUVWXYZ'; $lower='abcdefghijkmnpqrstuvwxyz'; $numbers='23456789'; $all=$upper+$lower+$numbers
              $pw=''; $pw+=$upper[(Get-Random -Minimum 0 -Maximum $upper.Length)]; $pw+=$lower[(Get-Random -Minimum 0 -Maximum $lower.Length)]; $pw+=$numbers[(Get-Random -Minimum 0 -Maximum $numbers.Length)]
              for($i=1;$i -le 5;$i++) { $pw+=$all[(Get-Random -Minimum 0 -Maximum $all.Length)] }
              return -join ($pw.ToCharArray() | Sort-Object { Get-Random })
          }
          if($env:CUSTOM_RDP_PASS){ $matKhau=$env:CUSTOM_RDP_PASS } else { $matKhau=New-PremiumPassword }
          $securePass=ConvertTo-SecureString $matKhau -AsPlainText -Force
          Remove-LocalUser -Name "LongDay2203" -ErrorAction SilentlyContinue
          New-LocalUser -Name "LongDay2203" -Password $securePass -AccountNeverExpires -Description "LongDay Premium User"
          Enable-LocalUser -Name "LongDay2203"
          Add-LocalGroupMember -Group "Administrators" -Member "LongDay2203"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "LongDay2203"
          echo "RDP_USER=LongDay2203" >> $env:GITHUB_ENV
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          Write-Host "‚úÖ T√†i kho·∫£n LongDay2203 ƒë√£ s·∫µn s√†ng" -ForegroundColor Green

      # SET WALLPAPER
      - name: üñºÔ∏è Set RDP Wallpaper
        run: |
          Write-Host "üîÑ ƒêang t·∫£i v√† ƒë·ªïi h√¨nh n·ªÅn RDP..." -ForegroundColor Cyan
          $url="https://raw.githubusercontent.com/truongcongdanh542013-art/-i/232a55d5596db3f6f78d22423e2e7353e13dca2c/DF651AEC-04F3-401D-899D-E1D540A1B488.jpeg"
          $path="$env:TEMP\wallpaper.jpg"
          [Net.ServicePointManager]::SecurityProtocol=[Net.SecurityProtocolType]::Tls12
          Invoke-WebRequest -Uri $url -OutFile $path -UseBasicParsing -ErrorAction Stop
          $rdpUser="LongDay2203"
          $sid=(Get-LocalUser $rdpUser).SID.Value
          $regPath="HKU\$sid\Control Panel\Desktop"
          New-ItemProperty -Path $regPath -Name Wallpaper -PropertyType String -Value $path -Force
          Write-Host "‚úÖ Wallpaper ƒë√£ set cho user $rdpUser" -ForegroundColor Green
          Write-Host "üéâ H√¨nh n·ªÅn RDP ƒë√£ c·∫≠p nh·∫≠t, s·∫Ω hi·ªÉn th·ªã khi user login!" -ForegroundColor Cyan

      # TAILSCALE
      - name: üåê THI·∫æT L·∫¨P M·∫†NG PREMIUM
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "üåê ƒêANG THI·∫æT L·∫¨P K·∫æT N·ªêI M·∫†NG" -ForegroundColor Yellow
          $msiPath="$env:TEMP\tailscale-premium.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          Remove-Item $msiPath -Force
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=LongDay-$env:GITHUB_RUN_ID --accept-routes --accept-dns --reset
          $ip=$null
          for($i=0;$i -lt 20;$i++) {
              $ip=& "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
              if($ip -match '^\d+\.\d+\.\d+\.\d+$'){ echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV; break }
              Start-Sleep -Seconds 3
          }
          if(-not $ip){ echo "TAILSCALE_IP=localhost" >> $env:GITHUB_ENV }

      # TH√îNG TIN K·∫æT N·ªêI
      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        run: |
          $matKhau=Get-Content $env:TEMP\rdp_password.txt
          $durationInput="${{ github.event.inputs.duration }}"
          switch($durationInput){ "1h" {$totalMinutes=60;$displayTime="1 gi·ªù"} "3h" {$totalMinutes=180;$displayTime="3 gi·ªù"} "5h40m" {$totalMinutes=340;$displayTime="5 gi·ªù 40 ph√∫t"} default {$totalMinutes=340;$displayTime="5 gi·ªù 40 ph√∫t"} }
          $timeZone=[System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $start=[System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(),$timeZone)
          $end=$start.AddMinutes($totalMinutes)
          Write-Host "üåê IP: $env:TAILSCALE_IP | User: LongDay2203 | Pass: $matKhau | Th·ªùi gian: $displayTime"

      # DUY TR√å PHI√äN
      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $totalMinutes=[int]$env:TOTAL_MINUTES
          $timeZone=[System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $start=[System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(),$timeZone)
          $end=$start.AddMinutes($totalMinutes)
          do {
              $now=[System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(),$timeZone)
              $remain=$end-$now
              $h=[math]::Max(0,[math]::Floor($remain.TotalHours))
              $m=[math]::Max(0,[math]::Floor($remain.TotalMinutes%60))
              $s=[math]::Max(0,[math]::Floor($remain.TotalSeconds%60))
              Write-Host "`r‚è≥ Th·ªùi gian c√≤n l·∫°i: $h gi·ªù $m ph√∫t $s gi√¢y" -NoNewline -ForegroundColor Cyan
              Start-Sleep -Seconds 5
          } while($remain.TotalSeconds -gt 0)
          Write-Host "`nüéØ H·∫æT TH·ªúI GIAN ‚Äî T·ª∞ ƒê·ªòNG D·ª™NG!" -ForegroundColor Red

      # D·ªåN D·∫∏P
      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          $steps=@(
            @{Name="X√≥a file password"; Script={Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue}},
            @{Name="V√¥ hi·ªáu h√≥a user"; Script={Disable-LocalUser -Name "LongDay2203" -ErrorAction SilentlyContinue}},
            @{Name="ƒê√≥ng k·∫øt n·ªëi Tailscale"; Script={& "$env:ProgramFiles\Tailscale\tailscale.exe" down --accept-risk=all -ErrorAction SilentlyContinue}},
            @{Name="X√≥a rule firewall"; Script={netsh advfirewall firewall delete rule name="RDP-Premium" -ErrorAction SilentlyContinue; netsh advfirewall firewall delete rule name="RDP-Premium-Out" -ErrorAction SilentlyContinue}},
            @{Name="Kh√¥i ph·ª•c RDP"; Script={Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 1 -Force -ErrorAction SilentlyContinue; Stop-Service -Name TermService -Force -ErrorAction SilentlyContinue}}
          )
          foreach($step in $steps){ Write-Host "‚îÇ üóëÔ∏è  $($step.Name)..." -NoNewline -ForegroundColor Gray; try{& $step.Script; Write-Host "`r‚îÇ ‚úÖ $($step.Name)" -ForegroundColor Green} catch{Write-Host "`r‚îÇ ‚ö†Ô∏è  $($step.Name) - ƒê√£ x·ª≠ l√Ω an to√†n" -ForegroundColor Yellow}; Start-Sleep -Milliseconds 300 }
          Write-Host "üéâ D·ªåN D·∫∏P HO√ÄN T·∫§T! H·∫∏N G·∫∂P L·∫†I üëã" -ForegroundColor Green
